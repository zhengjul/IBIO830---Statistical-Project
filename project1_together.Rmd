---
title: "Tiger Milkweed Butterflies (genus Danaus) Statistical Project"
author: "Julia Zheng & Kate Skocelas"
date: "10/15/2020"
output:  
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read in raw data
```{r input files}
#setwd("C:\\Dropbox\\Classes\\Classes\\IBIO 830 stats\\project1")
setwd("~/Desktop/stats/Project1/IBIO830---Statistical-Project")

# load raw data from csv file
butterfly_raw <- read.csv("Danaus.csv", header = TRUE)
```

### Load required libraries
```{r load libraries, message=FALSE}
if (!require(RColorBrewer)) install.packages('RColorBrewer')
library(RColorBrewer)

if (!require(rworldmap)) install.packages('rworldmap')
library(rworldmap)

if (!require(scales)) install.packages('scales')
library(scales)

if (!require(dplyr)) install.packages('dplyr')
library(dplyr)

if (!require(ggplot2)) install.packages('ggplot2')
library(ggplot2)
```

## Data cleaning and exploration
```{r clean data, echo=TRUE}
# Rename column where there is a typo 
names(butterfly_raw)[names(butterfly_raw) == "phyenotype..metamorphosis.stage."] <- "metamorphosis_stage"

# check for NAs in the data
sum(is.na(butterfly_raw)) # 132 NAs found 

# Remove NAs in the data columns we are looking at
butterfly_data <- butterfly_raw
butterfly_data <- butterfly_data[!is.na(butterfly_data$latitude),]
butterfly_data <- butterfly_data[!is.na(butterfly_data$longitude),]
butterfly_data <- butterfly_data[!is.na(butterfly_data$positional_accuracy),]
butterfly_data <- butterfly_data[!is.na(butterfly_data$scientific_name),]
butterfly_data <- butterfly_data[!is.na(butterfly_data$metamorphosis_stage),]
butterfly_data <- butterfly_data[!is.na(butterfly_data$observed_on),]
```

### Initial plotting
```{r look at structure}
# look at the structure of the data frame
str(butterfly_raw)
head(butterfly_raw)
```

#### Metamorphic stage of samples
```{r}
# number of samples in each metamorphic stage
count(butterfly_data, butterfly_data$metamorphosis_stage)
```


```{r plot metamorphic stage}
# Create bar plot of metamorphic stage
ggplot(butterfly_data, aes(x=metamorphosis_stage))+
  geom_bar(col="black", fill= c("turquoise2", "darkorchid4", "orange2", "red"))+
  labs(x="Metamorphic Stage", y="Number of Samples", title="Metamorphic Stage of Samples")+
  theme_classic()
```

There are significantly more samples of organisms in the "butterfly" metamorphic stage than in any of the other metamorphic stages. This may represent a sampling bias in the dataset. Individuals in the "butterfly" stage may be easier for amatuer naturalists to spot, or they may be more appealing to photograph and log. In the statistical tests section, we use a chi-squared goodnesss of fit test to test the null hypothesis that our data set does not accurately represent the expected average lifecyle durations of genus Danaus butterflies.


#### Metamorphic stage of sample compared to observation date
```{r metamorphic stage vs year observed}
# add year of observation to data frame
butterfly_data$year <- substr(butterfly_data$observed_on, nchar(butterfly_data$observed_on)-3 ,nchar(butterfly_data$observed_on))

# get the number of samples collected in each year
count(butterfly_data, butterfly_data$year)

#plot stage against year of observation
ggplot(butterfly_data, aes(x=year, fill=metamorphosis_stage))+
  geom_bar()+
  labs(x="Year", y="Number of Samples", title="Metamorphic Stage of Samples by Year Observed")+
  theme_classic()
```
The distribution of samples by year appears to follow the pattern expected by the rise in popularity of the iNaturalist website. Because 2020 is not yet complete, it has fewer samples (so far) than 2019, despite the increasing rise in number of users. 

```{r metamorphic stage vs month observed}

# add month of observation to data frame
butterfly_data$month <- substr(butterfly_data$observed_on, 1,2)
for(i in 1:nrow(butterfly_data)) {
  month <- butterfly_data$month[i]
  last_letter <- substr(month, 2,2)
  if(last_letter == "/") {
    month <- substr(month, 1,1)
  }
  butterfly_data$month[i] <- month
}

# get the number of samples collected in each month
butterfly_data$month_fac <- factor(butterfly_data$month, levels=c("1","2","3","4","5","6","7","8","9","10","11","12"))
count(butterfly_data, butterfly_data$month)

#plot stage against month of observation
ggplot(butterfly_data, aes(x=month_fac, fill=metamorphosis_stage))+
  geom_bar()+
  labs(x="Month", y="Number of Samples", title="Metamorphic Stage of Samples by Month Observed")+
  theme_classic()
```
The observations appear to have a bimodal distribution. The first peak is in March, and the second peak is in August. If these two normal distributions exist, they may indicate the peak butterfly seasons in two distinct climates. 

#### Positional accuracy vs. latitude and longitude
Positional accuracy in iNaturalist describes how far away the submitted observations are from the recorded location (longitude and latitude coordinates). This value represents meters away from the recorded location. Therefore, it is important for us to take a look at whether our coordinate information is accurate to where the genus Danaus was observed in nature and drop the outliers with extremely poor accuracy (ie those with large positional accuracy values).

```{r plot positional accuracy vs lat & long, fig.width=14, fig.height=7}
par(mfrow=c(1,2))

plot(butterfly_data$positional_accuracy ~butterfly_data$latitude, 
     xlab = "Latitude", 
     ylab = "Positional Accuracy", 
     pch = 19, 
     col = adjustcolor(1,0.4),
     main = "Positional Accuracy vs Latitude")

plot(butterfly_data$positional_accuracy ~butterfly_data$longitude, 
     xlab = "Longitude", 
     ylab = "Positional Accuracy", 
     pch = 19, 
     col = adjustcolor(1,0.4),
     main = "Positional Accuracy vs Longitude")

```

There are some outliers in our data, in particular in the datapoints that contain latitude or longitude greater than 30,000 meters away from actual observations. We decided to clean the data more thoroughly and remove any data points that are 15000 meters away from the recorded location.


```{r plot positional accuracy vs lat & long w/o outliers, fig.width=14, fig.height=7}

# remove outliers
butterfly_data <- butterfly_data %>% filter(positional_accuracy < 15000)

par(mfrow=c(1,2))

plot(butterfly_data$positional_accuracy ~butterfly_data$latitude, 
     xlab = "Latitude", 
     ylab = "Positional Accuracy", 
     pch = 19, 
     col = adjustcolor(1,0.4),
     main = "Positional accuracy vs Latitude")

plot(butterfly_data$positional_accuracy ~butterfly_data$longitude, 
     xlab = "Longitude", 
     ylab = "Positional Accuracy", 
     pch = 19, 
     col = adjustcolor(1,0.4),
     main = "Positional accuracy vs Longitude")
```
By removing the outliers, the y-axis maximum has changed from 30,000 to 12,000 meters. This is a significant improvement of maximum positional accuracy present in our dataset, and it allows us to be more certain that our dataset's longitude and latitude values are reasonably close to the actual observation locations.


### Species distribution across the world
#### Adding colours qualitatively with a library
```{r add colours qualitatively}
butterfly_data$scientific_name <- as.factor(butterfly_data$scientific_name)
jColors <- with(butterfly_data,
                data.frame(scientific_name = levels(scientific_name),
                           color = I(brewer.pal(nlevels(scientific_name), name = 'Accent'))))

butterfly_data_scatter <- data.frame(subset(butterfly_data, select = c(latitude, longitude, scientific_name)),
           matchRetVal = match(butterfly_data$scientific_name, jColors$scientific_name))
```

#### Plot points onto world map
```{r plot points onto world map, fig.width=14, fig.height=9}

plot(getMap(), 
     xlab = "Longitude",     
     ylab = "Latitude",     
     main = 'Genus Danaus (Tiger MilkWeed Butterfly) Observed Across the World')

points(butterfly_data_scatter$longitude, butterfly_data_scatter$latitude, 
       col=alpha(jColors$color[match(butterfly_data_scatter$scientific_name, jColors$scientific_name)],0.4), 
       pch=19,cex=1.3)

legend("bottom", inset=c(0,0), 
       legend = as.character(jColors$scientific_name),
       col = jColors$color, pch = 19, cex=0.7,
       xpd=TRUE, horiz=T)
```

There is a concentration of observations from the USA, in particular species Danaus plexippus. 
Additionally, there is a lack of samples from the eastern continents in the world. 
Even with this great disparity in available data, we can still observe differences in Danaus species (visual colour differences) spread across the globe.

## Statistical tests
### Chi-squared goodness of fit test for metamorphic stages
We conducted a Chi-squared goodness of fit on our categorical data describing the four metamorphic stages of genus Danaus butterflies.

From the following link, we learned the average duration of butterflies' metamorphic stages. 
#https://www.joyfulbutterfly.com/life-cycle-of-a-butterfly/

We make the assumption that the following information applies for genus Danaus across the world, time, and region.
<pre>
# butterfly life cycle

Egg:               5 days                              5/57.5 = 0.08695652

Caterpillar:       3.5 weeks = 24.5 days               24.5/57.5 = 0.426087

Chrysalis/Pupa:    1.5 weeks = 10.5 days               10.5/57.5 = 0.1826087

Adult butterfly:   2.5 weeks = 17.5 days               17.5/57.5 = 0.3043478

Total lifecycle:   5+24.5+10.5+17.5 = 57.5 days
</pre>
```{r chi-squared test}
chisq.test(table(butterfly_data$metamorphosis_stage), p = c(5, 24.5, 10.5, 17.5)/57.5)
```
Based on the chi-square goodness of fit test, the p-value is 2.2e-16 < 0.005, meaning this test strongly rejects the null hypothesis of no fit.
Thus, we conclude that our observed dataset for genus Danaus matches with the provided, predicted average butterfly lifecycle durations.

### Linear regression for observation month vs. latitude
Above, we suggested that the bimodal distribution of observations by month may be caused by a connection between observation month and observation location. Here, we hypothesize that a sample's observation month is related to the latitude of the observation location, because butterflies are most active in warm weather. 

```{r month observed vs latitude observed on}
# linear regression test
lr <- lm(butterfly_data$month~butterfly_data$latitude)
summary(lr)
```
Based on the results of the linear regression, we can reject the null hypothesis that here is no significant correlation between observation month and latitude.

## Summary of Results
This dataset on genus Danaus contains interesting observations of metamorphosis stages across the world over various months in the year.

We plotted 'Metamophoric stage of samples" to explore the dataset and astoundingly, the vast majority of samples were observed adult butterflies rather than in other stages of the butterfly life cycle.Thus, we conducted a chi-squared test on the categorical variable 'metamorphosis_stage' to determine whether the data observations match with the predicted durations of each metamorphosis stage.

Based on the statistical test, 'Chi-squared goodness of fit test', our p-value 2.2e-16 < 0.005, meaning this test strongly rejects the null hypothesis of no fit.
Thus, We conclude that our observed dataset for genus Danaus matches with the provided, predicted average butterfly lifecycle durations.

Our data analysis has found that the greatest number of recorded observations occur around months 7 to 10 (July to October), with greatest number of records from August.

# FIXME -- if statistical test on this works out please fill in the conclusion here!

Our dataset contained some outliers with respect to positional accuracy, seen in plots from 'Positional accuracy vs. latitude and longitude'. In INaturalist, positional accuracy describes how far away in meters was the observed butterfly compared to the actual recorded longitude and latitude values. Therefore, we want to remove outliers that are too far away from recorded location.

After removing the outliers using positional accuracy as criteria, we plotted 'Species distribution across the world'. We see that there is a concentration of observations from the USA. Additionally, there is a lack thereof from the eastern continents in the world. Even with this great disparity in available data, we can still observe differences in Danaus species (visual colour differences) spread across the globe.

The species that is most recorded is species Danaus plexippus. However, due to sparcity of data collected, we are unable to acertain whether this is an artifact of biased sampling or if there are more Danaus plexippus in the world compared to all other genus Danaus species.

In future works, we hope to include more samples from all across the world to reduce sampling bias.

